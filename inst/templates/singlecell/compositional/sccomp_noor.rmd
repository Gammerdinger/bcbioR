---
title: "scccomp on Noor's data"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---



```{r setup, cache=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
# Load libraries
library(Seurat)
#library(harmony)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(data.table)
library(DT)
library(patchwork)
#library(clustree)
library(SummarizedExperiment)
library(SingleCellExperiment)
#library(Matrix.utils)
library(pheatmap)
#library(MAST)
#library(DESeq2)
library(DEGreport)
#library(apeglm)
library(future)
library(sccomp)
# Set seed for reproducibility
set.seed(1454944673L)
opts_chunk[["set"]](
    audodep = TRUE,
    cache = FALSE,
    cache.lazy = FALSE,
    error = TRUE,
    echo = FALSE,
    fig.height = 5L,
    fig.retina = 2L,
    fig.width = 11,
    message = FALSE,
    tidy = TRUE,
    warning = FALSE
)

 
 if (future::supportsMulticore()) {
   future::plan(future::multicore)
 } else {
   future::plan(future::multisession)
 }
```


## Load object and subset

```{r}
seurat_noor <- readRDS("BAT_GSE160585.rds")

subset_noor <-  subset(x = seurat_noor, subset= condition %in% c("TN","cold7"))

Idents(object = subset_noor) <- "celltype"

DefaultAssay(subset_noor) <- "RNA"

```




## Sccomp 


To test for differential cell composition we use [sccomp](https://github.com/MangiolaLaboratory/sccomp) a method for differential composition and variability analyses that jointly models data count distribution, compositionality, group-specific variability, and proportion meanâ€“variability association, being aware of outliers.

Our model includes condition (TN vs. cold). For each cell type we get results for the intercept and our factors. We can see the results of the fit, the effects of the factor on composition and variability. You also can see the uncertainty around those effects. In the output table, the estimate columns start with the prefix c_ indicate composition, or with v_ indicate variability (when formula_variability is set). We have not used formula_variability so we only have v_ estimates for our intercept.

```{r}
sccomp_result = 
  subset_noor |>
  sccomp_estimate( 
    formula_composition = ~ condition, 
    .sample =  sample, 
    .cell_group = celltype, 
    bimodal_mean_variability_association = TRUE,
    cores = 1 
  ) |> 
  sccomp_remove_outliers(cores = 1, verbose = FALSE) |> # Optional
  sccomp_test()


sccomp_result
```

### Fold Change

```{r}
sccomp_result |> 
   sccomp_proportional_fold_change(
     formula_composition = ~  condition,
     from =  "TN", 
     to = "cold7"
    ) |> 
  select(celltype, statement)
```





### Boxplot of results

Here we see proportion of each cell type in our two groups (TN and cold7). The blue boxplots represent the posterior predictive check. If the model is likely to be descriptively adequate to the data, the blue box plot should roughly overlay with the black box plot, which represents the observed data. Dots indicate samples and outlier samples are coloured in red. Boxplots colored red indicate significant differences in proportion between our groups.

```{r}

sccomp_result |> 
  sccomp_boxplot(factor = "condition")
```

### 1-D visualization

A plot of estimates of differential composition (c_) on the x-axis. The error bars represent 95% credible intervals. The dashed lines represent the minimal effect that the hypothesis test is based on. An effect is labelled as significant if bigger than the minimal effect according to the 95% credible interval. We get figures for both factors in our model.

```{r}

sccomp_result |> 
  plot_1D_intervals()


```



## R Session 

Below is the output of the R session used to generate this report. Included is information on R version, OS, and versions of packages installed and used.

```{r sessionInfo}
# Get session information
sessionInfo()
```